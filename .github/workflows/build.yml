name: Build Nexen

on:
  push:
    branches: ['**']
    tags: ['v*']

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

jobs:
  windows:
    strategy:
      matrix:
        platform: [
          {aot: false, singleFile: true, aotString: ""},
          {aot: true, singleFile: false, aotString: " - AoT"}
        ]
      fail-fast: false
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Restore packages
        run: dotnet restore -r win-x64 -p:PublishAot="${{ matrix.platform.aot }}" -p:BuildWithNetFrameworkHostedCompiler=true

      - name: Write commit SHA1 to file
        uses: ./.github/actions/build-sha1-action

      - name: Build C++ core (InteropDLL)
        run: msbuild -nologo -v:m -clp:ForceConsoleColor -m -p:Configuration=Release -p:Platform=x64 -p:PlatformToolset=v143 -t:InteropDLL Nexen.sln

      - name: Build UI (restore native libs)
        run: dotnet build -c Release -r win-x64 --no-restore UI/UI.csproj
        continue-on-error: true

      - name: Package Dependencies.zip
        run: ./scripts/package-dependencies.ps1 -Configuration Release
        shell: pwsh

      - name: Build UI
        run: msbuild -nologo -v:m -clp:ForceConsoleColor -m -p:Configuration=Release -p:Platform=x64 -p:PlatformToolset=v143 -t:UI Nexen.sln

      - name: Publish Nexen
        run: dotnet publish --no-restore -c Release -p:PublishAot="${{ matrix.platform.aot }}" -p:SelfContained="${{ matrix.platform.aot }}" -p:PublishSingleFile="${{ matrix.platform.singleFile }}" -p:OptimizeUi="true" -r win-x64 UI/UI.csproj

      - name: Upload Nexen
        uses: actions/upload-artifact@v4
        with:
          name: Nexen (Windows${{ matrix.platform.aotString }})
          path: |
            build/TmpReleaseBuild/Nexen.exe


  linux:
    strategy:
      matrix:
        compiler: [gcc, clang, clang_aot]
        platform: [
          {os: ubuntu-22.04, path: x64},
          {os: ubuntu-22.04-arm, path: arm64}
        ]
        exclude:
          # ARM64 AOT build doesn't seem to work properly (crashes when launched)
          - platform: { os: ubuntu-22.04-arm, path: arm64 }
            compiler: clang_aot
        include:
          - compiler: gcc
            make_flags: "USE_GCC=true"
          - compiler: clang
            make_flags: ""
          - compiler: clang_aot
            make_flags: "USE_AOT=true"
      fail-fast: false
    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Install dependencies
        run: |
          sudo apt-get update -qy
          sudo apt-get install -qy libsdl2-dev ccache # The compilers are already installed on GitHub's runners.

      # Install GCC 13 for C++23 <format> support (default GCC 11 on ubuntu-22.04 doesn't have it)
      - name: Install GCC 13
        if: matrix.compiler == 'gcc'
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y g++-13 gcc-13
          echo "CC=gcc-13" >> $GITHUB_ENV
          echo "CXX=g++-13" >> $GITHUB_ENV

      # Install LLVM 18 for C++23 support (default clang on ubuntu-22.04 doesn't support c++23)
      # Also install libc++ since the system libstdc++ doesn't have <format>
      - name: Install LLVM 18
        if: matrix.compiler != 'gcc'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y libc++-18-dev libc++abi-18-dev

      - name: Setup CCache
        uses: ./.github/actions/setup-ccache-action

      - name: Write commit SHA1 to file
        uses: ./.github/actions/build-sha1-action

      # stderr is not detected as a TTY, so diagnostics are by default printed without colours;
      # forcing colours makes the log a little nicer to read.
      # Pass CC/CXX explicitly since makefile ignores environment variables
      # For clang, also use libc++ for C++23 <format> support
      - name: Build Nexen
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            make -j$(nproc) -O ${{ matrix.make_flags }} LTO=true STATICLINK=true SYSTEM_LIBEVDEV=false CC=gcc-13 CXX=g++-13
          else
            make -j$(nproc) -O ${{ matrix.make_flags }} LTO=true STATICLINK=true SYSTEM_LIBEVDEV=false CC=clang-18 CXX=clang++-18 NEXENFLAGS="-stdlib=libc++"
          fi

      - name: Upload Nexen
        uses: actions/upload-artifact@v4
        with:
          name: Nexen (Linux - ${{ matrix.platform.os }} - ${{ matrix.compiler }})
          path: bin/linux-${{ matrix.platform.path }}/Release/linux-${{ matrix.platform.path }}/publish/Nexen

  appimage:
    strategy:
      matrix:
        compiler: [clang_appimage]
        platform: [
          {os: ubuntu-22.04, name: x64, script: Linux/appimage/appimage.sh},
          {os: ubuntu-22.04-arm, name: ARM64, script: Linux/appimage/appimage-arm64.sh}
        ]
    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Install dependencies
        run: |
          sudo apt-get update -qy
          sudo apt-get install -qy libsdl2-dev libfuse2 ccache # The compilers are already installed on GitHub's runners.

      # Install LLVM 18 for C++23 support (ubuntu-22.04 default clang doesn't support c++23)
      # Also install libc++ since the system libstdc++ doesn't have <format>
      - name: Install LLVM 18
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y libc++-18-dev libc++abi-18-dev

      - name: Setup CCache
        uses: ./.github/actions/setup-ccache-action

      - name: Write commit SHA1 to file
        uses: ./.github/actions/build-sha1-action

      - name: Build Nexen (AppImage)
        run: |
          ${{ matrix.platform.script }}
      - name: Upload Nexen (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: Nexen (Linux ${{ matrix.platform.name }} - AppImage)
          path: Nexen.AppImage


  macos:
    strategy:
      matrix:
        compiler: [clang, clang_aot]
        platform: [
          {os: macos-14, arch: arm64}
        ]
        include:
          - compiler: clang
            make_flags: ""
          - compiler: clang_aot
            make_flags: "USE_AOT=true"
      fail-fast: false
    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: Install dependencies
        run: |
          brew install sdl2 ccache llvm

      - name: Get brew prefix
        run: |
          echo "brewPrefix=$(brew --prefix)" >> "$GITHUB_ENV"

      - name: Setup CCache
        uses: ./.github/actions/setup-ccache-action
        with:
          ccache-path: '${{ env.brewPrefix }}/opt/ccache/libexec'

      - name: Write commit SHA1 to file
        uses: ./.github/actions/build-sha1-action

      # Use Homebrew's LLVM clang which supports C++23, instead of Apple clang
      - name: Build Nexen
        run: |
          LLVM_PREFIX="$(brew --prefix llvm)"
          export PATH="${LLVM_PREFIX}/bin:$PATH"
          export CC="${LLVM_PREFIX}/bin/clang"
          export CXX="${LLVM_PREFIX}/bin/clang++"
          # Pass linker flags to use Homebrew's libc++ instead of system libc++
          # NEXENFLAGS is used for both compile and link in the makefile
          LIBCXX_FLAGS="-stdlib=libc++ -nostdinc++ -isystem ${LLVM_PREFIX}/include/c++/v1"
          LINK_FLAGS="-L${LLVM_PREFIX}/lib/c++ -Wl,-rpath,${LLVM_PREFIX}/lib/c++ -lc++ -lc++abi"
          make CC="$CC" CXX="$CXX" NEXENFLAGS="${LIBCXX_FLAGS} ${LINK_FLAGS}" ${{ matrix.make_flags }} -j$(sysctl -n hw.logicalcpu)

      - name: Sign binary
        env:
          APP_NAME: bin/osx-${{ matrix.platform.arch }}/Release/osx-${{ matrix.platform.arch }}/publish/Nexen.app
          CERT_DATA: ${{ secrets.MACOS_CERTIFICATE }}
          CERT_PASS: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          ENTITLEMENTS: UI/Nexen.entitlements
          SIGNING_IDENTITY: Nexen
        run: |
          # Export certs
          echo "$CERT_DATA" | base64 --decode > /tmp/certs.p12
          # Create keychain
          security create-keychain -p actions macos-build.keychain
          security default-keychain -s macos-build.keychain
          security unlock-keychain -p actions macos-build.keychain
          security set-keychain-settings -t 3600 -u macos-build.keychain
          # Import certs to keychain
          security import /tmp/certs.p12 -k ~/Library/Keychains/macos-build.keychain -P "$CERT_PASS" -T /usr/bin/codesign -T /usr/bin/productsign
          # Key signing
          security set-key-partition-list -S apple-tool:,apple: -s -k actions macos-build.keychain
          # print identities
          security find-identity -v macos-build.keychain

          echo "[INFO] Signing app file"
          codesign --force --deep --timestamp --keychain macos-build.keychain --options=runtime --entitlements "$ENTITLEMENTS" --sign "$SIGNING_IDENTITY" "$APP_NAME"

      - name: Zip Nexen.app
        run: |
          ditto -c -k --sequesterRsrc --keepParent bin/osx-${{ matrix.platform.arch }}/Release/osx-${{ matrix.platform.arch }}/publish/Nexen.app bin/osx-${{ matrix.platform.arch }}/Release/Nexen.app.zip

      - name: Upload Nexen
        uses: actions/upload-artifact@v4
        with:
          name: Nexen (macOS - ${{ matrix.platform.os }} - ${{ matrix.compiler }})
          path: bin/osx-${{ matrix.platform.arch }}/Release/Nexen.app.zip


  # Create GitHub Release with artifacts when a version tag is pushed
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [windows, linux, appimage, macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Windows builds
          cp "artifacts/Nexen (Windows)/Nexen.exe" "release-assets/Nexen-Windows-x64.exe" || true
          cp "artifacts/Nexen (Windows - AoT)/Nexen.exe" "release-assets/Nexen-Windows-x64-AoT.exe" || true

          # Linux builds (gcc)
          cp "artifacts/Nexen (Linux - ubuntu-22.04 - gcc)/Nexen" "release-assets/Nexen-Linux-x64-gcc" || true
          chmod +x "release-assets/Nexen-Linux-x64-gcc" || true
          cp "artifacts/Nexen (Linux - ubuntu-22.04-arm - gcc)/Nexen" "release-assets/Nexen-Linux-ARM64-gcc" || true
          chmod +x "release-assets/Nexen-Linux-ARM64-gcc" || true

          # Linux builds (clang)
          cp "artifacts/Nexen (Linux - ubuntu-22.04 - clang)/Nexen" "release-assets/Nexen-Linux-x64" || true
          chmod +x "release-assets/Nexen-Linux-x64" || true
          cp "artifacts/Nexen (Linux - ubuntu-22.04-arm - clang)/Nexen" "release-assets/Nexen-Linux-ARM64" || true
          chmod +x "release-assets/Nexen-Linux-ARM64" || true

          # Linux AOT builds
          cp "artifacts/Nexen (Linux - ubuntu-22.04 - clang_aot)/Nexen" "release-assets/Nexen-Linux-x64-AoT" || true
          chmod +x "release-assets/Nexen-Linux-x64-AoT" || true

          # Linux AppImage builds
          cp "artifacts/Nexen (Linux x64 - AppImage)/Nexen.AppImage" "release-assets/Nexen-Linux-x64.AppImage" || true
          chmod +x "release-assets/Nexen-Linux-x64.AppImage" || true
          cp "artifacts/Nexen (Linux ARM64 - AppImage)/Nexen.AppImage" "release-assets/Nexen-Linux-ARM64.AppImage" || true
          chmod +x "release-assets/Nexen-Linux-ARM64.AppImage" || true

          # macOS builds (ARM64 only - Intel x64 deprecated on GitHub Actions)
          cp "artifacts/Nexen (macOS - macos-14 - clang)/Nexen.app.zip" "release-assets/Nexen-macOS-ARM64.zip" || true
          cp "artifacts/Nexen (macOS - macos-14 - clang_aot)/Nexen.app.zip" "release-assets/Nexen-macOS-ARM64-AoT.zip" || true

          ls -la release-assets/

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          fail_on_unmatched_files: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
