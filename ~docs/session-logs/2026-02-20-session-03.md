# Session Log — 2026-02-20 Session 03

## Session Overview

**Branch:** `features-atari-lynx`
**Focus:** Comprehensive Lynx audit (Core + UI), fixes, hardware-reference tests, allocation benchmarks, documentation

## Work Completed

### 1. Movie/TAS Analysis
- Verified all 9 Lynx buttons (U/D/L/R/A/B/O1/O2/Pause) are properly handled
- Movie key string `"UDLRabOoP"` confirmed correct
- Piano roll, BK2 import/export, InputHud all working
- Found 3 UI bugs in InputConfig switch methods (missing LynxController)

### 2. Core Code Audit
- Audited all Lynx core C++ files
- Found **25 items**: 3 Critical, 6 High, 9 Medium, 7 Low
- Key findings: HLE boot doesn't copy cart data, MAPCTL bits 4-5 not gated, LeftHand mode not applied, timer burst on clock source change

### 3. UI Code Audit
- Audited all C# files referencing Lynx
- Found **14 items**: 1 Critical, 4 High, 3 Medium, 6 Low
- Key findings: InputConfig missing LynxController, ShortcutHandler missing Lynx, MovieData PAL framerate wrong

### 4. GitHub Issues Created
- **#409** — `[Epic 14] Lynx Emulator Accuracy & UI Completeness Audit`
- **#410** — `[14.1] InputConfig missing LynxController` → **CLOSED**
- **#411** — `[14.2] ShortcutHandler missing Lynx` → **CLOSED**
- **#412** — `[14.3] MovieData PAL framerate` → **CLOSED**
- **#413** — `[14.4] Fix input lag` → **CLOSED**
- **#414** — `[14.5] MAPCTL bits 4-5 not implemented`
- **#415** — `[14.6] LeftHand mode not applied`
- **#416** — `[14.7] Pen index register routing`
- **#417** — `[14.8] Timer clock source burst`

### 5. UI Fixes (commit `ccd3a3b4`)
- **InputConfig.cs**: Added LynxController to `HasPresets()`, `HasTurbo()`, `CanConfigure()`, `IsTwoButtonController()`
- **ShortcutHandler.cs**: Added Lynx to `EnableAllLayers()`, `UpdateAllCoreConfig()`
- **MovieData.cs**: PAL framerate returns 75 Hz for Lynx instead of 50 Hz

### 6. Core Input Lag Fix (commit `d7d73a0a`)
- Moved `UpdateInputState()`, `SetJoystick()`, `SetSwitches()` from after to before frame execution loop in `LynxConsole::RunFrame()`
- Eliminates 1-frame input delay

### 7. Hardware Reference Tests (commit `d7d73a0a`)
- Created `Core.Tests/Lynx/LynxHardwareReferenceTests.cpp`
- **63 tests** in 15 sections referencing Epyx Developer's Guide, Handy docs, BLL docs
- All 63 passing — total Lynx tests now **828**

### 8. Allocation Benchmarks (commit `d7d73a0a`)
- Created `Core.Benchmarks/Lynx/LynxAllocBench.cpp`
- **25 benchmarks** in 10 categories (state sizes, frame buffer, RAM patterns, save states, sprites, collision, timers, audio, input)
- Total Lynx benchmarks now **119**

### 9. Documentation
- Created `docs/LYNX-EMULATION.md` — Full hardware overview, architecture, memory map, TAS support
- Created `docs/LYNX-TESTING.md` — Test/benchmark running guide with all filter commands
- Created `docs/LYNX-ACCURACY.md` — Per-subsystem accuracy tracking with percentages
- Created `docs/LYNX-HARDWARE-BUGS.md` — Documented hardware bugs (13.8, 13.9, 13.10, 13.12)
- Updated `README.md` — Added Atari Lynx to supported systems table, added Lynx docs section

## Commits

| Hash | Description |
|------|-------------|
| `ccd3a3b4` | Fix Lynx UI: InputConfig, ShortcutHandler, MovieData PAL framerate - #410 #411 #412 |
| `d7d73a0a` | Add 63 hardware-ref correctness tests, 25 alloc benchmarks, fix input lag - #409 #413 |

## Test Results

- **828 Lynx tests** — all passing
- **119 Lynx benchmarks** — all registered
- Full build: no errors, no warnings

## Issues Summary

| Issue | Title | Status |
|-------|-------|--------|
| #409 | Epic: Lynx Accuracy & UI Audit | Open (tracking) |
| #410 | InputConfig missing LynxController | ✅ Closed |
| #411 | ShortcutHandler missing Lynx | ✅ Closed |
| #412 | MovieData PAL framerate | ✅ Closed |
| #413 | Input lag fix | ✅ Closed |
| #414 | MAPCTL bits 4-5 | Open |
| #415 | LeftHand mode sprites | Open |
| #416 | Pen index routing | Open |
| #417 | Timer clock burst | Open |

## Files Changed

### New Files
- `Core.Tests/Lynx/LynxHardwareReferenceTests.cpp` — 63 hardware-reference tests
- `Core.Benchmarks/Lynx/LynxAllocBench.cpp` — 25 allocation benchmarks
- `docs/LYNX-EMULATION.md` — Hardware overview & architecture
- `docs/LYNX-TESTING.md` — Test & benchmark guide
- `docs/LYNX-ACCURACY.md` — Per-subsystem accuracy status
- `docs/LYNX-HARDWARE-BUGS.md` — Documented hardware bugs

### Modified Files
- `UI/Config/InputConfig.cs` — Added LynxController to 4 switch methods
- `UI/Utilities/ShortcutHandler.cs` — Added Lynx to 2 methods
- `MovieConverter/MovieData.cs` — Fixed PAL framerate for Lynx
- `Core/Lynx/LynxConsole.cpp` — Fixed input lag (moved UpdateInputState before frame loop)
- `Core.Tests/Core.Tests.vcxproj` — Added LynxHardwareReferenceTests.cpp
- `Core.Benchmarks/Core.Benchmarks.vcxproj` — Added LynxAllocBench.cpp
- `README.md` — Added Lynx to systems table, added Lynx docs section
