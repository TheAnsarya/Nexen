# Nexen Pansy Integration - Phase 1.5 Implementation

**Date:** 2026-01-26
**Started:** ~04:00 UTC
**Duration:** ~2 hours

## Objectives

Implement two critical features for reliable Pansy export:

1. **Background CDL Recording** - Record execution data without requiring debugger window
2. **ROM Hash Verification** - Prevent data corruption from mismatched ROM versions

## Session Overview

### Part 1: ROM Hash Verification (CRC32)

**Status:** ✅ COMPLETED
**Commit:** `38dfccf7`
**GitHub Issue:** Phase 1.5 #4 (Background CDL & CRC Verification)

#### Implementation Details

**Problem:** The Pansy header had a `RomCrc32` field that was always written as 0 (placeholder). This meant:

- Different ROM versions (translations, hacks) could overwrite each other's Pansy files
- No way to verify if a Pansy file matches the currently loaded ROM

**Solution:**

1. Implemented custom CRC32 calculator using IEEE polynomial (0xEDB88320)
   - Note: `System.IO.Hashing.Crc32` was not available in the project
2. Added methods to PansyExporter.cs:
   - `InitCrc32Table()` - One-time lookup table generation
   - `ComputeCrc32(byte[] data)` - IEEE polynomial CRC32
   - `CalculateRomCrc32(CpuType, MemoryType)` - Get ROM bytes via `DebugApi.GetMemoryState()`
   - `ReadHeader(string path)` - Parse existing Pansy file header
3. Created `PansyHeader` record for structured header data
4. Modified `AutoExport()` to:
   - Calculate current ROM's CRC32
   - Read existing Pansy file's header (if exists)
   - Compare CRCs before updating
   - Create CRC-suffixed file if mismatch: `{name}-{CRC32}.pansy`
5. Modified `Export()` to accept optional `romCrc32Override` parameter

**Files Modified:**

- [PansyExporter.cs](../../UI/Debugger/Labels/PansyExporter.cs) - Added ~90 lines

### Part 2: Background CDL Recording

**Status:** ✅ COMPLETED
**Commit:** `e95a7858`
**GitHub Issue:** Phase 1.5 #4 (Background CDL & CRC Verification)

#### Implementation Details

**Problem:** CDL recording only happened when the debugger window was open. Users had to:

1. Open debugger (F12)
2. Play the game
3. Close debugger
4. Export Pansy

**Solution:**

1. Created new class `BackgroundPansyExporter.cs`:
   - `OnRomLoaded(RomInfo)` - Called when ROM loads, starts recording
   - `OnRomUnloaded()` - Called on ROM close, saves final Pansy
   - `StartCdlRecording()` - Initializes debugger core + enables CDL flags
   - `StopCdlRecording()` - Cleans up timer
   - `OnAutoSaveTick()` - Periodic save via Dispatcher

2. Key API usage discovered:

   ```csharp
   // Initialize debugger without opening window
   DebugApi.InitializeDebugger();
   
   // Enable CDL recording for a specific CPU
   ConfigApi.SetDebuggerFlag(cpuType.GetDebuggerFlag(), true);
   ```

3. Added configuration options to `IntegrationConfig.cs`:
   - `BackgroundCdlRecording` (default: false) - Enable/disable feature
   - `AutoSaveIntervalMinutes` (default: 5) - How often to auto-save
   - `SavePansyOnRomUnload` (default: true) - Save when ROM closes

4. Hooked into `MainWindow.axaml.cs`:
   - `GameLoaded` notification → `BackgroundPansyExporter.OnRomLoaded()`
   - `EmulationStopped` notification → `BackgroundPansyExporter.OnRomUnloaded()`

**Files Created:**

- [BackgroundPansyExporter.cs](../../UI/Debugger/Labels/BackgroundPansyExporter.cs) - 160 lines

**Files Modified:**

- [IntegrationConfig.cs](../../UI/Config/IntegrationConfig.cs) - Added 3 properties
- [MainWindow.axaml.cs](../../UI/MainWindow.axaml.cs) - Added hook calls

## Testing Results

### Build Verification

- ✅ Debug build: Success (0 errors, 0 warnings)
- ✅ Release build: Success (0 errors, 0 warnings)

### Runtime Testing (Pending)

- [ ] Test background CDL recording with NES ROM
- [ ] Test CRC verification with different ROM versions
- [ ] Test auto-save timer fires correctly
- [ ] Test save on ROM unload
- [ ] Test UI configuration options

## Git Commits

| Commit | Message | Files Changed |
| -------- | --------- | --------------- |
| `38dfccf7` | feat: add ROM CRC32 verification to prevent pansy corruption | 1 (PansyExporter.cs) |
| `e95a7858` | feat: add background CDL recording without debugger window | 3 (BackgroundPansyExporter.cs, IntegrationConfig.cs, MainWindow.axaml.cs) |

## What's Next

### Phase 1.5 Remaining Work

- [ ] Add UI configuration in DebuggerConfigWindow.axaml
- [ ] Add localization strings for new options
- [ ] Runtime testing of both features

### Phase 2: Testing & Validation

- [ ] Create comprehensive test suite
- [ ] Test all supported platforms
- [ ] Performance and memory testing

### Phase 3: Enhanced Features

- [ ] Memory regions export
- [ ] Cross-references export
- [ ] DiztinGUIsh import/export

## Technical Notes

### CRC32 Implementation
Used IEEE polynomial (0xEDB88320) with table-based optimization. The `System.IO.Hashing` namespace was not available in the Nexen project, so we implemented a custom CRC32 matching the standard IEEE 802.3 specification.

### Thread Safety

- Timer callback uses `Dispatcher.UIThread.Post()` for UI-thread-safe operations
- File I/O happens synchronously on timer tick

### Memory Considerations

- ROM bytes retrieved via `DebugApi.GetMemoryState()` - returned as copy
- Timer creates periodic GC pressure (every 5 minutes default)
- Consider pooling for high-frequency exports

